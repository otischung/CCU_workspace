**System Programming Homework 14  資工2B 408410120 鍾博丞**

-----------------------------------------

## 環境配置

Operating System: Ubuntu 20.04 LTS using KDE plasma

**CPU: AMD R9 3900X 12C 24T @ 3.8GHz**

RAM: 32GB DDR4 3600MHz (Double channel)

SSD: WD Black 256G WDS256G1X0C TLC (Seq. R: 2050MB/s, Seq. W: 700MB/s, Random R: 170K IOPS, Random W: 130K IOPS)



## 程式操作方式

輸入 make 之後，執行檔會在 bin 資料夾裡

./bin/\<exe\> \<points> \<threads\>

這裡有**兩支**程式，功能皆為使用 Monde Carlo 計算 pi 的值

`pi` 為教授的範例程式，修改原先限制 16 threads 為 1024 threads，使其可以在多核伺服器上更有效率得運作

`mypi` 為我自己的實作方式，使用雙重迴圈判斷每個 thread 是否更新到 volatile global variable 供 signal handler 讀取。論壇上有討論過使用 `if (i % 10000 == 0)` 判斷是否更新全域變數，理論上使用雙重迴圈的判斷次數是迴圈內使用 if 的 2 倍，不過實測結果差異沒有很大

程式有接收兩個 signal，分別為 SIGINT (ctrl + c) 與 SIGHUP (logout)，**當按下 ctrl + c 時，會印出截至目前計算出來的 pi 是多少**，並且印出當前進度與進度條 (terminal 欄位須大於 50 才會顯示進度條)；**當在一秒內連續按下二次 ctrl + c 的時候，會印出截至目前計算出來的 pi 是多少，並結束程式**

`signal(SIGHUP, SIGIGN);` 的目的只是為了如果要測大一點的數字 (points) 的話，我可以登出伺服器，先做我自己的事，等待一段時間之後我再回來看結果。話雖如此，我還是會盡量不要佔用公共資源太久



## 實作方式

`pi` 為教授的範例程式，在全域變數中宣告 global_hit，並且使用 mutex lock 保護 global_hit，避免同時有兩個以上的 threads 進入此 critical section

`mypi` 為我自己的實作方式，為了能使 signal handler 讀取到資料，故在全域變數宣告 volatile 陣列，陣列大小為 thread 數量，因為每個 thread 都是操作各自的 cnt 和 hit，所以沒有 critical section，因此實作上沒有使用任何 lock 的機制

但是，宣告 volatile 代表每次更動都要強制寫入到 RAM 裡，限縮編譯器優化空間，考量宣告 volatile 只是為了能使 signal handler 讀取到資料，而人類手動操作 ctrl + c 的速度遠不及 CPU 速度，故在 thread 裡宣告 local_cnt 與 local_hit，每 10 萬次才更新到 RAM 裡，最後計算結束再更新一次，藉此優化效率

也因此，按下 ctrl + c 讀取當前數值時，需讀取陣列裡所有數值做加總，因為不使用 lock，陣列的資料有新有舊，故由此計算 pi 的值誤差會較大，**當前進度也只能僅供參考**



## 效率測試

以下測試皆為使用純 CLI 模式 (開機後立刻切換到 tty2)，只使用 tmux 與 htop 監測系統，避免不必要的資源浪費

| 項目                           | time ./bin/pi $(echo "2 ^ 32" \| bc) 24 | 測量值                                | time ./bin/mypi $(echo "2 ^ 32" \| bc) 24 | 測量值                                |
| ------------------------------ | --------------------------------------- | ------------------------------------- | ----------------------------------------- | ------------------------------------- |
| 1                              | 20.565                                  | 3.14163079                            | 2.962                                     | 3.14159061                            |
| 2                              | 26.218                                  | 3.14163079                            | 2.955                                     | 3.14153976                            |
| 3                              | 25.083                                  | 3.14163079                            | 2.957                                     | 3.14156747                            |
| 4                              | 24.183                                  | 3.14163079                            | 2.951                                     | 3.14160748                            |
| 5                              | 24.648                                  | 3.14163079                            | 2.947                                     | 3.14157182                            |
| 6                              | 25.339                                  | 3.14163079                            | 2.95                                      | 3.14157749                            |
| 7                              | 25.302                                  | 3.14163079                            | 2.958                                     | 3.14160936                            |
| 8                              | 23.829                                  | 3.14163079                            | 2.954                                     | 3.14158126                            |
| 9                              | 25.709                                  | 3.14163079                            | 2.949                                     | 3.14160539                            |
| 10                             | 22.957                                  | 3.14163079                            | 2.935                                     | 3.14159449                            |
| <font color=#FF0000>AVG</font> | <font color=#FF0000>24.3833</font>      | <font color=#0000FF>3.14163079</font> | <font color=#FF0000>2.9518</font>         | <font color=#0000FF>3.14158451</font> |
| STDEV                          | 1.646604                                | 0                                     | 0.007465                                  | 2.1684E-5                             |
| *DEV (%)                       |                                         | 1.2139E-3                             |                                           | 2.5912E-4                             |

*DEV means deviation: abs(measure_value - theoretical_value) / theoretical_value * 100%

可以發現，因為我並沒有使用任何 lock 機制，所以執行效率是**勝過範例程式的**，代價就是需要幾個 thread，陣列空間就要開幾個，以空間換取時間

不過，教授的範例程式的 rand() 並沒有使用 srand() 做初始化，而我的程式有，故教授的範例程式每次所測量的結果都是一樣的



---------------------------------------------------------

最後的壓縮指令 
`tar jcvf filename.tar.bz2 target`

