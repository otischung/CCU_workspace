#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <assert.h>
#include <time.h>

int main() {
	ssize_t fd;
	const off_t G = (1 << 30);
	const off_t M = (1 << 20);

	printf("這個程式會在當前的目錄下，製造檔案FileHole\n");
	fd = open("./FileHole", O_RDWR | O_CREAT | O_TRUNC, S_IRUSR | S_IWUSR);
	if (fd < 0)
		perror("無法製造myHole");
	//ftruncate(fd, 6*G);
	//lseek將『檔案指標』由開始位置向後移動 1G，lseek比較可能出錯，用 assert 檢查一下
    
	time_t timer1, timer2;
    timer1 = time(NULL);

	assert(lseek(fd, G - 200 * M, SEEK_SET) != -1);
	//寫入“1”，很少出錯，懶得檢查
	for (off_t i = 0; i < 2 * M; ++i) {
		write(fd, "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", \
		sizeof("11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"));
	}
	//lseek將『檔案指標』由『目前』位置向後移動 2G，lseek比較可能出錯，用 assert 檢查一下
	assert(lseek(fd, 2 * G - 100 * M, SEEK_CUR) != -1);
	for (off_t i = 0; i < M; ++i) {
		write(fd, "22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222", \
		sizeof("22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222"));
	}
	//lseek將『檔案指標』由『目前』位置向後移動 3G，lseek比較可能出錯，用 assert 檢查一下
	assert(lseek(fd, 3 * G - 200 * M, SEEK_CUR) != -1);
	for (off_t i = 0; i < 2 * M; ++i) {
		write(fd, "33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333", \
		sizeof("33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333"));
	}

	timer2 = time(NULL);

    printf("time(create FileHole) = %ld sec \n", timer2 - timer1);

	close(fd);
	system("ls FileHole -alhs");
	return 0;
}
