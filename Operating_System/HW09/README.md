**Operating System Homework 02  資工3B 408410120 鍾博丞**

-----------------------------------------

## 環境配置

Operating System: Arch Linux 5.15.4-arch1-1 using KDE plasma

**CPU: AMD R9 3900X 12C 24T @ 3.8GHz**

RAM: 32GB DDR4 3600MHz (Double channel)

SSD: ADATA SX8200Pro 1TB TLC (Seq. R: 3500MB/s, Seq. W: 3000MB/s, Random R: 451.3K IOPS, Random W: 325.6K IOPS)

## WikiChip

https://en.wikichip.org/wiki/amd/ryzen_9/3900x

找不到 Compiler support，僅使用 `-march=native`

![R9_3900X](https://www.kitguru.net/wp-content/uploads/2019/07/2x-CCD-and-IOD.png)

## 實驗結果

在實驗中有這段程式碼

```c
int delay_size = rand_r(&rand_seq) % k;  // k is the max. value of loop.
for (int i = 0; i < delay_size; i++);  // sleep random time.
```

因為 thread 之間會有隱含的同步效應，所以要讓他 sleep 一下

### CFLAGS=-g -O3 -pthread, k=73

> 0, 2112900
> 1, 1255697
> 2, 1570678
> 3, 2292517
> 4, 1379424
> 5, 1714642
> 6, 815644
> 7, 848575
> 8, 248175
> 9, 743131
> 10, 744885
> 11, 227213
> 12, 2256758
> 13, 1352341
> 14, 1543941
> 15, 2115930
> 16, 1451662
> 17, 1622177
> 18, 859933
> 19, 880514
> 20, 259517
> 21, 741940
> 22, 744549
> 23, 237880
> AVG = 1167525.958333
> STDEV = 637786.889178

### CFLAGS=-g -pthread, k=73

> 0, 942951
> 1, 1042728
> 2, 994661
> 3, 956823
> 4, 1058953
> 5, 988570
> 6, 601439
> 7, 652980
> 8, 671620
> 9, 602786
> 10, 656560
> 11, 671104
> 12, 959574
> 13, 1034887
> 14, 991675
> 15, 941335
> 16, 975253
> 17, 992567
> 18, 599109
> 19, 653601
> 20, 675850
> 21, 594602
> 22, 648794
> 23, 677515
> AVG = 816080.708333
> STDEV = 177280.110509

少了 O3，整體效能下降

### CFLAGS=-g -pthread, k=73000

> 0, 73176
> 1, 73547
> 2, 73687
> 3, 74062
> 4, 74240
> 5, 72770
> 6, 73611
> 7, 73300
> 8, 73878
> 9, 73505
> 10, 74077
> 11, 74093
> 12, 74187
> 13, 74105
> 14, 72171
> 15, 73737
> 16, 68780
> 17, 74214
> 18, 73765
> 19, 74149
> 20, 72909
> 21, 73358
> 22, 73173
> 23, 72936
> AVG = 73392.916667
> STDEV = 1097.015319

sleep 的時間變長之後，確實比較公平

### CFLAGS=-g -O3 -pthread, k=73000

> 0, 2044724
> 1, 1349360
> 2, 1383774
> 3, 2260163
> 4, 1472750
> 5, 1464172
> 6, 913594
> 7, 955025
> 8, 257789
> 9, 849462
> 10, 877383
> 11, 236087
> 12, 2139241
> 13, 1418581
> 14, 1343012
> 15, 1988528
> 16, 1433697
> 17, 1402512
> 18, 963156
> 19, 973403
> 20, 265426
> 21, 853129
> 22, 861504
> 23, 242740
> AVG = 1164550.500000
> STDEV = 577117.981041

可以看出 O3 做出優化之後，變得比較不公平

### CFLAGS=-g -pthread, k=73000000

> 0, 74
> 1, 73
> 2, 74
> 3, 74
> 4, 74
> 5, 74
> 6, 73
> 7, 71
> 8, 74
> 9, 74
> 10, 74
> 11, 75
> 12, 71
> 13, 71
> 14, 73
> 15, 74
> 16, 67
> 17, 74
> 18, 70
> 19, 74
> 20, 74
> 21, 74
> 22, 71
> 23, 71
> AVG = 72.833333
> STDEV = 1.840894

再把 sleep 加長，就很公平了

### CFLAGS=-g -O3 -pthread -march=native, k=73

> 0, 1690184
> 1, 1294209
> 2, 1072231
> 3, 1964334
> 4, 1367121
> 5, 1258387
> 6, 1149711
> 7, 963072
> 8, 327400
> 9, 1219883
> 10, 1023862
> 11, 364029
> 12, 1770066
> 13, 1306997
> 14, 1037361
> 15, 1711816
> 16, 1294811
> 17, 1175708
> 18, 1170220
> 19, 982833
> 20, 357484
> 21, 1203562
> 22, 1017473
> 23, 368376
> AVG = 1128797.083333
> STDEV = 429485.360954

感覺加了 `-march=native` 沒有太大差別
